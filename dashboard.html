<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Key System</title>
<style>
body{margin:0;font-family:Arial,sans-serif;background:#0b0f1a;color:white;display:flex;}

/* Sidebar */
.sidebar{
    position:fixed;
    left:-250px;
    top:0;
    width:250px;
    height:100%;
    background:#111827;
    padding-top:60px;
    transition:0.3s;
    z-index:1000;
}
.sidebar.active{left:0;}
.sidebar a{
    display:block;
    padding:15px 20px;
    color:#00ff88;
    text-decoration:none;
    font-weight:bold;
    cursor:pointer;
}
.sidebar a:hover{background:#1f2937;}

/* Overlay */
.overlay{
    position:fixed;
    top:0;left:0;width:100%;height:100%;
    background:rgba(0,0,0,0.4);
    display:none; z-index:900;
}
.overlay.active{display:block;}

/* Main content */
.main-content{
    flex:1;
    margin-left:0;
    transition:0.3s;
    padding:20px;
    width:100%;
}
.main-content.shift{margin-left:250px;}

/* Navbar */
.navbar{
    display:flex;
    align-items:center;
    background:#111827;
    padding:10px;
    position:sticky;
    top:0;
    z-index:800;
}
.navbar h1{flex:1;color:#00ff88;margin:0;}
.menu-icon{
    font-size:1.8rem;
    cursor:pointer;
    color:#00ff88;
}

/* Cards, Inputs, Buttons */
input, select{width:100%;padding:10px;margin:10px 0;border-radius:8px;border:none;background:#1f2937;color:white;}
button{padding:10px 15px;background:#00ff88;border:none;border-radius:8px;color:black;font-weight:bold;cursor:pointer;margin-top:10px;}
.card{background:#111827;padding:15px;margin:10px 0;border-radius:12px;}
</style>
</head>
<body>

<div class="sidebar" id="sidebar">
    <a id="menuUsers">üë• Ver Usu√°rios</a>
    <a id="menuGenerate">‚ö° Gerar Key</a>
    <a id="menuCredits">üí∞ Adicionar Cr√©ditos</a>
    <a id="menuLogout">üö™ Sair</a>
</div>

<div class="overlay" id="overlay" onclick="toggleMenu()"></div>

<div class="main-content" id="main">
    <div class="navbar">
        <div class="menu-icon" onclick="toggleMenu()">‚ò∞</div>
        <h1>Key System Dashboard</h1>
    </div>
    <div id="content">
        <p>Carregando...</p>
    </div>
</div>

<script type="module">
import { db, auth } from "./js/firebase.js";
import { doc, setDoc, getDoc, getDocs, updateDoc, collection, Timestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

let currentUserEmail = null;
let currentUserRole = null;

// Elements
const sidebar=document.getElementById("sidebar");
const overlay=document.getElementById("overlay");
const main=document.getElementById("main");
const content=document.getElementById("content");

// Menu click
document.getElementById("menuUsers").onclick=viewUsers;
document.getElementById("menuGenerate").onclick=generateKeyForm;
document.getElementById("menuCredits").onclick=addCreditsForm;
document.getElementById("menuLogout").onclick=logout;

// Toggle menu
window.toggleMenu=()=>{
    sidebar.classList.toggle("active");
    overlay.classList.toggle("active");
    main.classList.toggle("shift");
}

// Logout
async function logout(){
    await signOut(auth);
    window.location.href="index.html";
}

// Get current user
auth.onAuthStateChanged(async(user)=>{
    if(user){
        currentUserEmail = user.email;
        // Get role from Firestore
        const docSnap = await getDoc(doc(db,"users",currentUserEmail));
        if(!docSnap.exists()){ alert("Usu√°rio n√£o encontrado!"); return; }
        currentUserRole = docSnap.data().role;
        // Hide admin menu if not ADM
        if(currentUserRole!=="admin"){
            document.getElementById("menuUsers").style.display="none";
            document.getElementById("menuCredits").style.display="none";
        }
        content.innerHTML="<p>Bem-vindo, "+currentUserEmail+"</p>";
    }else{
        window.location.href="index.html";
    }
});

// ------------------ FUN√á√ïES ------------------

// Ver usu√°rios (s√≥ ADM)
async function viewUsers(){
    toggleMenu();
    if(currentUserRole!=="admin"){ alert("Acesso negado"); return; }
    content.innerHTML="<h2>Carregando usu√°rios...</h2>";
    const querySnap = await getDocs(collection(db,"users"));
    let html="<h2>Todos os Usu√°rios</h2>";
    querySnap.forEach(docSnap=>{
        const u=docSnap.data();
        html+=`<div class='card'>${u.email} | Cr√©ditos: ${u.credits} | Role: ${u.role}</div>`;
    });
    content.innerHTML=html;
}

// Form gerar key
function generateKeyForm(){
    toggleMenu();
    content.innerHTML=`
        <h2>Gerar Key</h2>
        <input type="text" id="keyValidity" placeholder="Validade (ex: 24h, 7d, 30d)">
        <button onclick="generateKey()">Gerar</button>
    `;
}

// Gerar key
async function generateKey(){
    const validity=document.getElementById("keyValidity").value.trim();
    if(!validity){ alert("Digite validade"); return; }
    const key="KEY-"+Math.random().toString(36).substr(2,9).toUpperCase();
    await setDoc(doc(db,"keys",key),{
        owner: currentUserEmail,
        validity: validity,
        status:"active",
        createdAt:Timestamp.now()
    });
    alert("Key gerada: "+key);
}

// Form adicionar cr√©ditos (s√≥ ADM)
function addCreditsForm(){
    toggleMenu();
    if(currentUserRole!=="admin"){ alert("Acesso negado"); return; }
    content.innerHTML=`
        <h2>Adicionar Cr√©ditos</h2>
        <input type="text" id="creditEmail" placeholder="Email do usu√°rio">
        <input type="number" id="creditAmount" placeholder="Quantidade de cr√©ditos">
        <button onclick="addCredits()">Adicionar</button>
    `;
}

// Adicionar cr√©ditos
async function addCredits(){
    const email=document.getElementById("creditEmail").value.trim();
    const amount=parseInt(document.getElementById("creditAmount").value);
    if(!email||!amount){ alert("Preencha todos os campos"); return; }
    const userDoc = doc(db,"users",email);
    const docSnap = await getDoc(userDoc);
    if(!docSnap.exists()){ alert("Usu√°rio n√£o existe"); return; }
    const currentCredits = docSnap.data().credits||0;
    await updateDoc(userDoc,{credits:currentCredits+amount});
    alert("Cr√©ditos adicionados!");
    viewUsers();
}
</script>
</body>
</html>
